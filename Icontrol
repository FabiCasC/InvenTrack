package com.inventario.controller;

import com.inventario.db.DBConnection;
import com.inventario.model.Movement;
import com.inventario.model.Product;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;

public class InventoryController {

    public void addProduct(Product p) throws SQLException {
        String sql = "INSERT INTO productos (nombre,tipo,cantidad,stock_minimo,unidad,precio) VALUES (?,?,?,?,?,?)";
        try (Connection c = DBConnection.getConnection(); PreparedStatement ps = c.prepareStatement(sql)) {
            ps.setString(1, p.getNombre());
            ps.setString(2, p.getTipo());
            ps.setInt(3, p.getCantidad());
            ps.setInt(4, p.getStockMinimo());
            ps.setString(5, p.getUnidad());
            ps.setDouble(6, p.getPrecio());
            ps.executeUpdate();
        }
    }

    public List<Product> listProducts() throws SQLException {
        List<Product> lista = new ArrayList<>();
        String sql = "SELECT * FROM productos";
        try (Connection c = DBConnection.getConnection(); Statement st = c.createStatement(); ResultSet rs = st.executeQuery(sql)){
            while (rs.next()){
                Product p = new Product(rs.getInt("id"), rs.getString("nombre"), rs.getString("tipo"),
                        rs.getInt("cantidad"), rs.getInt("stock_minimo"), rs.getString("unidad"), rs.getDouble("precio"));
                lista.add(p);
            }
        }
        return lista;
    }

    public void registrarMovimiento(Movement m) throws SQLException {
        Connection c = DBConnection.getConnection();
        try {
            c.setAutoCommit(false);
            String insertMove = "INSERT INTO movimientos (id_producto,tipo_movimiento,fecha,cantidad,detalle) VALUES (?,?,?,?,?)";
            try (PreparedStatement ps = c.prepareStatement(insertMove)) {
                ps.setInt(1, m.getIdProducto());
                ps.setString(2, m.getTipoMovimiento());
                ps.setTimestamp(3, Timestamp.valueOf(m.getFecha()));
                ps.setInt(4, m.getCantidad());
                ps.setString(5, m.getDetalle());
                ps.executeUpdate();
            }
            String updateProd = m.getTipoMovimiento().equals("entrada")
                    ? "UPDATE productos SET cantidad = cantidad + ? WHERE id = ?"
                    : "UPDATE productos SET cantidad = cantidad - ? WHERE id = ?";
            try (PreparedStatement ps2 = c.prepareStatement(updateProd)) {
                ps2.setInt(1, m.getCantidad());
                ps2.setInt(2, m.getIdProducto());
                ps2.executeUpdate();
            }

            // Verificar stock minimo y crear reabastecimiento si aplica
            String chk = "SELECT cantidad, stock_minimo FROM productos WHERE id = ?";
            try (PreparedStatement ps3 = c.prepareStatement(chk)) {
                ps3.setInt(1, m.getIdProducto());
                try (ResultSet rs = ps3.executeQuery()){
                    if (rs.next()){
                        int cant = rs.getInt("cantidad");
                        int min = rs.getInt("stock_minimo");
                        if (cant <= min){
                            String ins = "INSERT INTO reabastecimientos (id_producto, fecha_reabastecimiento, cantidad_solicitada, estado) VALUES (?, NOW(), ?, 'pendiente')";
                            try (PreparedStatement ps4 = c.prepareStatement(ins)) {
                                ps4.setInt(1, m.getIdProducto());
                                ps4.setInt(2, min * 2);
                                ps4.executeUpdate();
                            }
                        }
                    }
                }
            }
            c.commit();
        } catch (SQLException ex) {
            c.rollback();
            throw ex;
        } finally {
            c.setAutoCommit(true);
            c.close();
        }
    }
}
